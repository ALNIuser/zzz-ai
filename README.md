Архитектура системы
Система представляет собой ассинхронную, многокомпонентную AI-техподдержку со следующим взаимодействием:

text
Звонящий абонент → Asterisk PBX → ARI Handler → Media Server → [STT → LLM → TTS] → Asterisk → Звонящий
Компоненты системы
1. Взаимодействие с Asterisk (ari_handler.py)
Назначение: Прием входящих звонков через Asterisk REST Interface (ARI)

Подключается к Asterisk по WebSocket для получения событий

При входящем звонке создает мост (bridge) типа "mixing"

Создает ExternalMedia канал для передачи RTP-потока на внешний сервер

Перенаправляет аудио на media_server.py по указанному IP:PORT

Использует кодек G.711 μ-law (ulaw) для совместимости с Asterisk

2. Основной медиа-сервер (media_server.py)
Назначение: Обработка аудиопотока, управление диалогом и координация всех компонентов

Принимает RTP-поток от Asterisk на порту 4000

Реализует VAD (Voice Activity Detection) для определения начала/конца речи

Координирует работу STT, LLM и TTS через ThreadPoolExecutor

Управляет состоянием диалога и контекстом разговора

Обрабатывает множественные одновременные звонки через объекты Session

3. Распознавание речи (yandex_stt.py)
Назначение: Преобразование речи в текст через Yandex SpeechKit

Принимает PCM-аудио в формате s16le, mono, 8kHz

Отправляет в Yandex Cloud Speech-to-Text API

Возвращает распознанный текст на русском языке

Использует синхронный REST API

4. Синтез речи (yandex_tts.py)
Назначение: Преобразование текста в речь через Yandex SpeechKit

Генерирует естественную речь на русском языке

Поддерживает несколько голосов (oksana, alena, filipp, ermil)

Возвращает PCM-аудио в формате s16le, mono, 8kHz

Конфигурируется через переменные окружения

5. LLM-клиент (llm_client.py)
Назначение: Генерация ответов через DeepSeek API

Отправляет диалоговый контекст в DeepSeek Chat Completions API

Использует модель deepseek-chat с температурой 0.2 для детерминированных ответов

Обрабатывает промпт-инжектинг с ролевой моделью оператора техподдержки

6. RTP обработка (rtp_listener.py, rtp_sender.py)
Назначение: Работа с RTP-протоколом на низком уровне

rtp_listener.py: Потоковый STT через WebSocket (альтернативный режим)

rtp_sender.py: Отправка RTP-пакетов с аудио обратно в Asterisk

7. Конфигурация голосов (tts_config.py)
Назначение: Выбор голоса для TTS

Интерактивный выбор из 4 голосов Yandex

Описания голосов (пол, характер)

Рабочий процесс диалога
Прием звонка:

Asterisk отправляет событие StasisStart в ARI

Создается мост и ExternalMedia канал

RTP-поток направляется на media_server:4000

Обнаружение речи:

Media Server анализирует RMS (Root Mean Square) для VAD

Порог активации: 250 единиц

Минимальная длительность фразы: 1000мс

Пауза для конца фразы: 900мс

Обработка запроса:

Аудио конвертируется из μ-law в PCM

Отправляется в Yandex STT → получаем текст

Текст добавляется в историю диалога

Отправляется в DeepSeek LLM с промптом оператора

Генерация ответа:

LLM генерирует ответ по строгим правилам

Ответ синтезируется через Yandex TTS в PCM

PCM конвертируется в μ-law для Asterisk

Отправляется обратно через RTP

Промпт-инжектинг и ролевая модель
Система использует сложный промпт для имитации оператора-женщины технической поддержки:

Компания: "СКС Сервис" (видеонаблюдение, СКУД, пожарная сигнализация Bolid)

Стиль общения: женский, профессиональный, спокойный

Формат ответов: только текст для озвучки, без маркдауна

Правила диалога: продолжение контекста, без повторных вопросов

Эскалация: при критических ситуациях или по запросу клиента

Ограничения: только профильные темы, вежливый отказ от оффтопа

Особенности реализации
Многопоточность:

ThreadPoolExecutor для параллельной обработки

Lock-объекты для синхронизации отправки аудио и диалога

Неблокирующая обработка входящих RTP-пакетов

Обработка ошибок:

Логирование в файл dialog_log.txt с временными метками

Graceful degradation при отсутствии API-ключей

Контроль таймаутов при сетевых запросах

Конфигурируемость:

Все настройки через .env файл

Поддержка разных голосов TTS

Настраиваемые пороги VAD

Выбор модели DeepSeek через переменные окружения

Безопасность:

Ключи API не хардкодятся

Валидация входящих RTP-пакетов

Изоляция сессий для разных звонков

Требования к окружению
Аппаратные:

Сервер Asterisk с включенным ARI

Доступ к интернету для Yandex Cloud и DeepSeek API

Поддержка кодека G.711 μ-law

Программные:

Python 3.7+

Библиотеки: aioari, aiohttp, websocket-client, audioop

API-ключи: Yandex Cloud, DeepSeek

Сетевые:

Открытые порты: ARI (8088), RTP (4000)

Доступность сервисов Yandex Cloud и DeepSeek API

Расширяемость системы
Эскалация в Telegram: Заготовка для уведомлений в критических ситуациях

Альтернативный STT: Потоковое распознавание через WebSocket

Многопользовательская поддержка: Каждый звонок в отдельной сессии

Аналитика: Логирование всех диалогов для обучения и улучшения
